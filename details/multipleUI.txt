TODO add to multiple UI, API setup$

var scopes = configuration.GetValue<string>("DownstreamApi:Scopes");
string[] initialScopes = scopes.Split(' ');
services.AddMicrosoftIdentityWebApiAuthentication(configuration, "AzureAdApi", "AutomationApi");
services.AddMicrosoftIdentityWebAppAuthentication(configuration, "AzureAd")
    .EnableTokenAcquisitionToCallDownstreamApi(initialScopes)
    .AddMicrosoftGraph("https://graph.microsoft.com/v1.0", scopes)
    .AddInMemoryTokenCaches(); // todo needs be replaced with shared cache
services.AddAuthorization(policies =>
{
    policies.AddPolicy("access_as_user", p =>
    {
        p.AddAuthenticationSchemes("AutomationApi");
        p.RequireClaim("http://schemas.microsoft.com/identity/claims/scope", "access_as_user");
        p.RequireClaim("aud", configuration["AzureAdApi:ClientId"]);
    });
});
services.AddControllersWithViews(options =>
{
    options.InputFormatters.Add(new TextPlainInputFormatter());
    options.OutputFormatters.Add(new TextPlainOutputFormatter());
});
services.AddRazorPages().AddMvcOptions(options =>
{
    var policy = new AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddAuthenticationSchemes(CookieAuthenticationDefaults.AuthenticationScheme, "AutomationApi", "OpenIdConnect")
        .Build();
    
    options.Filters.Add(new AuthorizeFilter(policy));
}).AddMicrosoftIdentityUI();